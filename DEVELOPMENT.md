# 地电场优势方位角计算系统 - 开发说明文档

## 1. 开发背景与目标

地电场优势方位角是地球电磁观测中的重要参数，用于研究地下电导率异常、地震电磁前兆等现象。本系统旨在提供一套高效、准确的地电场优势方位角计算工具，将原始观测数据转化为有价值的科研结果。

## 2. 系统架构

系统采用前后端分离的架构：

```
+----------------+      +------------------+      +----------------+
| 数据库服务     | <--> | 计算服务后端     | <--> | 前端应用       |
| (Oracle)       |      | (Flask API)      |      | (Web客户端)    |
+----------------+      +------------------+      +----------------+
```

- **数据层**：Oracle数据库存储原始地电场观测数据
- **服务层**：Flask RESTful API提供数据处理和计算服务
- **展示层**：Web前端展示计算结果（非本项目范围）

## 3. 算法原理

### 3.1 地电场优势方位角定义

地电场优势方位角是指地电场变化主要方向与南北或东西方向所成的夹角。它反映了地下电导率结构的非均匀性和各向异性特征。

### 3.2 基本计算原理

计算优势方位角主要基于以下步骤：

1. 获取不同方向的地电场分量时间序列数据
2. 通过傅里叶变换计算各分量的频谱特性
3. 提取主要频率成分的振幅信息
4. 计算不同方向分量之间的比值关系
5. 计算方位角

### 3.3 傅里叶变换与调和分析

系统使用FFT（快速傅里叶变换）对地电场时间序列进行频域分析，计算各频率的振幅系数。调和分析系数计算公式为：

```
Ck = √(ak² + bk²)
```

其中ak和bk分别是傅里叶级数的余弦和正弦系数：

```
ak = (2/N) * Σ[x(i) * cos(2πki/N)]
bk = (2/N) * Σ[x(i) * sin(2πki/N)]
```

在本系统中，我们使用numpy的FFT函数直接计算，并取前n个频率分量的振幅之和作为信号强度的度量。

### 3.4 方位角计算公式

根据不同方向地电场分量的振幅比值，方位角计算公式如下：

- **EW/NW**: 90° + 180°/π * arctan(√2 * A_NW / A_EW - 1)
- **EW/NE**: 90° - 180°/π * arctan(√2 * A_NE / A_EW - 1)
- **NS/NW**: 180° - 180°/π * arctan(√2 * A_NW / A_NS - 1)
- **NS/NE**: 180°/π * arctan(√2 * A_NE / A_NS - 1)
- **NS/EW**: 180°/π * arctan(A_EW / A_NS)

其中A_NS、A_EW、A_NE、A_NW分别是南北、东西、东北和西北方向地电场分量的振幅。

## 4. 算法实现流程

### 4.1 总体流程

```
+----------------+      +------------------+      +----------------+      +----------------+
| 数据获取       | ---> | 数据预处理       | ---> | FFT频谱分析    | ---> | 方位角计算     |
+----------------+      +------------------+      +----------------+      +----------------+
```

### 4.2 详细流程

1. **数据获取**
   - 通过API接收查询参数（台站、时间范围等）
   - 从数据库获取对应的地电场时间序列数据

2. **数据预处理**
   - 处理缺失值（使用向后填充方法）
   - 数据按日期分组

3. **FFT频谱分析**
   - 对每个方向的地电场分量进行FFT变换
   - 计算振幅谱
   - 提取前N个谐波分量的振幅之和

4. **方位角计算**
   - 检查数据完整性，确保所有必要分量都有效
   - 根据方位角公式计算各个方向的方位角
   - 生成结果数据集

## 5. 代码实现关键点

### 5.1 FFT计算优化

通过numba加速和LRU缓存提高FFT计算性能：

```python
@staticmethod
@lru_cache(maxsize=128)
def compute_fft(values, order):
    """使用FFT计算地电场调和分析系数 - 带缓存"""
    if len(values) == 0:
        return 0.0
        
    try:
        # 直接使用numpy数组，避免pandas转换开销
        fft_result = fft(values)
        amplitudes = 2.0 * np.abs(fft_result) / len(values)
        return np.sum(amplitudes[1:order + 1])
    except Exception as e:
        print(f"FFT计算错误: {e}")
        return 0.0
```

### 5.2 方位角计算核心函数

使用numba加速方位角计算：

```python
@numba.jit(nopython=True)
def _calculate_azimuth(amplitude_ns, amplitude_ew, amplitude_ne, amplitude_nw):
    """计算方位角核心函数 - 使用numba加速"""
    results = {}
    
    # 预先计算常数
    factor = 180.0 / pi
    sqrt2 = sqrt(2.0)
    
    # EW/NW
    if amplitude_ew > 0 and amplitude_nw > 0:
        angle = 90.0 + factor * arctan(sqrt2 * amplitude_nw / amplitude_ew - 1.0)
        results[0] = angle  # 'EW/NW'
    
    # ... 其他方向计算 ...
    
    return results
```

### 5.3 数据处理优化

按日期分组处理数据，避免逐日循环：

```python
# 按日期分组处理，避免循环
# 创建日期列以便分组
df['date'] = pd.to_datetime(df.index.date)

# 按日期分组
grouped = df.groupby('date')

# 使用并行处理加速计算
results = {}
for date, group in grouped:
    date_str = date.strftime('%Y-%m-%d')
    azimuth = AzimuthCalc.compute_daily_azimuth(group)
    if azimuth:
        results[date_str] = azimuth
```

## 6. 数据要求和项目ID说明

### 6.1 数据要求

系统要求地电场数据包含以下分量：
- 南北方向(NS)
- 东西方向(EW)
- 东北方向(NE)
- 西北方向(NW)

### 6.2 项目ID对应关系

系统识别两组项目ID：

**第一组装置**:
- 3411: NS方向
- 3412: EW方向
- 3413: NE方向
- 3414: NW方向

**第二组装置**:
- 3421: NS方向
- 3422: EW方向
- 3423: NE方向
- 3424: NW方向

## 7. 性能优化技术

### 7.1 计算优化

1. **Numba加速**
   - 使用`@numba.jit(nopython=True)`装饰器编译核心计算函数
   - 避免Python解释器开销，接近C语言性能

2. **LRU缓存**
   - 使用`@lru_cache`减少重复计算
   - 适用于相同输入的FFT计算

3. **向量化操作**
   - 使用NumPy向量化操作替代循环
   - 提高大量数据处理效率

### 7.2 数据处理优化

1. **分组处理**
   - 使用Pandas的groupby功能批量处理数据
   - 减少循环次数和复杂度

2. **数据库连接优化**
   - 使用上下文管理器处理数据库连接
   - 确保资源及时释放

## 8. 测试与验证

### 8.1 单元测试

系统应开发以下单元测试：
- FFT计算函数测试
- 方位角计算函数测试
- 数据预处理功能测试

### 8.2 集成测试

- API端点功能测试
- 数据库连接测试
- 完整流程测试

### 8.3 性能测试

- 大数据量处理性能测试
- 并发请求处理能力测试

## 9. 扩展与未来开发

1. **算法扩展**
   - 支持更多方位角计算方法
   - 添加异常检测功能

2. **系统扩展**
   - 增加数据可视化模块
   - 开发批处理功能
   - 实现数据异常自动报警

3. **接口扩展**
   - 提供批量数据处理接口
   - 添加实时数据处理支持

## 10. 已知问题与解决方案

1. **数据缺失处理**
   - 问题：原始数据可能存在缺失
   - 解决：使用向后填充(bfill)方法处理缺失值

2. **计算稳定性**
   - 问题：除数为零导致计算错误
   - 解决：添加分母验证，确保所有用于计算的振幅值大于零

3. **数据库连接稳定性**
   - 问题：长时间运行可能导致数据库连接丢失
   - 解决：使用连接池和自动重连机制 